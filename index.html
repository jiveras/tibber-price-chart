<html>
    <head>
        <title>Elpriser</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

        <style>
            .wrapper,
            html,
            body {
                height: 100%;
                margin: 0;
            }

            .wrapper {
                display: flex;
                flex-direction: column;
            }

            .graph {
                flex: 1 1;
            }
        </style>
    </head>

    <body>
        <div class="wrapper">
            <div class="graph" id="graph">
                <canvas id="myChart" style="width: 100%; height: 100%"></canvas>
            </div>
        </div>
    </body>

    <script type="text/javascript">
        var myChart = null;
        var priceData = null;

        function updatePriceData() {
            var xhr = new XMLHttpRequest();
            xhr.responseType = "json";
            xhr.open("GET", "/api/price");
            xhr.onload = function () {
                priceData = this.response;

                updateGraph();
            };
            xhr.send();
        }

        function updateGraph() {
            var currentHour = new Date().toTimeString().slice(0, 2);

            var labels = [];
            var backgroundColors = [];
            var foundCurrentHour = false;
            for (var i = 0; i < priceData.length; i++) {
                labels.push(priceData[i].startsAt.slice(11, 16));

                if (labels[i].slice(0, 2) == currentHour && !foundCurrentHour) {
                    backgroundColors.push("rgba(54, 255, 132, 0.2)");
                    foundCurrentHour = true;
                } else [backgroundColors.push("rgba(54, 162, 235, 0.2)")];
            }

            var totalPrice = [];
            for (var i = 0; i < priceData.length; i++) {
                totalPrice.push(priceData[i].total);
            }

            labels.push("00:00");
            totalPrice.push(0);

            var chartData = {
                labels: labels,
                datasets: [
                    {
                        label: "Elpriser (" + new Date().toTimeString().slice(0,8) + ")",
                        data: totalPrice,
                        borderColor: "rgba(0, 0, 0, 1)",
                        backgroundColor: backgroundColors,
                        borderWidth: 1,
                        steppedLine: true,

                        lineTension: 0,
                    },
                ],
            };

            var config = {
                type: "bar",
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,

                    animation: {
                        onComplete: function () {
                            var chartInstance = this.chart,
                                ctx = chartInstance.ctx;
                            ctx.font = Chart.helpers.fontString(
                                Chart.defaults.global.defaultFontSize,
                                Chart.defaults.global.defaultFontStyle,
                                Chart.defaults.global.defaultFontFamily
                            );
                            ctx.textAlign = "center";
                            ctx.textBaseline = "bottom";

                            this.data.datasets.forEach(function (dataset, i) {
                                var meta =
                                    chartInstance.controller.getDatasetMeta(i);
                                meta.data.forEach(function (bar, index) {
                                    var data = dataset.data[index];
                                    if (data > 0) {
                                        ctx.fillText(
                                            data.toFixed(2),
                                            bar._model.x,
                                            bar._model.y - 5
                                        );
                                    }
                                });
                            });
                        },
                    },
                },
            };

            if (!myChart) {
                myChart = new Chart(document.getElementById("myChart"), config);
            } else {
                myChart.data = chartData;
                myChart.update();
            }
        }

        updatePriceData();

        setInterval(updateGraph, 15 * 10 * 1000);
    </script>
</html>
