<html>
    <head>
        <title>Elpriser</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

        <style>
            .wrapper,
            html,
            body {
                height: 100%;
                margin: 0;
            }

            .wrapper {
                display: flex;
                flex-direction: column;
            }

            .graph {
                flex: 1 1;
            }
        </style>
    </head>

    <body>
        <div class="wrapper">
            <pre id="lastUpdate"></pre>
            <div class="graph" id="graph">
                <canvas id="myChart" style="width: 100%; height: 100%"></canvas>
            </div>
        </div>
    </body>

    <script type="text/javascript">
        var myChart = null;
        var priceData = null;

        function updatePriceData() {
            var xhr = new XMLHttpRequest();
            xhr.responseType = "json";
            xhr.open("GET", "/api/price");
            xhr.onload = function () {
                priceData = this.response;

                updateGraph();
            };
            xhr.send();
        }

        function updateGraph() {
            c.innerHTML = new Date().toTimeString();
            var currentHour = new Date().toTimeString().slice(0, 2);

            var labels = [];
            var backgroundColors = [];
            for (var i = 0; i < priceData.length; i++) {
                labels.push(priceData[i].startsAt.slice(11, 16));

                if (labels[i].slice(0, 2) == currentHour) {
                    backgroundColors.push("rgba(54, 255, 132, 0.2)");
                } else [backgroundColors.push("rgba(54, 162, 235, 0.2)")];
            }

            var totalPrice = [];
            for (var i = 0; i < priceData.length; i++) {
                totalPrice.push(priceData[i].total);
            }

            var chartData = {
                labels: labels,
                datasets: [
                    {
                        label: "Elpriser",
                        data: totalPrice,
                        borderColor: "rgba(0, 0, 0, 1)",
                        backgroundColor: backgroundColors,
                        borderWidth: 1,
                        steppedLine: true,

                        lineTension: 0,
                    },
                ],
            };

            var config = {
                type: "bar",
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                },
            };

            if (!myChart) {
                myChart = new Chart(document.getElementById("myChart"), config);
            } else {
                myChart.data.datasets[0].data.pop();
                myChart.data.datasets[0].data.push(chartData);
            }
        }

        updatePriceData();

        setInterval(updateGraph, 10 * 1000);
    </script>
</html>
